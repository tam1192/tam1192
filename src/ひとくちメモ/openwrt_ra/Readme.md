# openwrt で ra を受け取る時に注意すること

えぇ...と思った。

# 🎵 本日の一曲

<iframe width="312" height="176" src="https://ext.nicovideo.jp/thumb/sm31667442" scrolling="no" style="border:solid 1px #ccc;" frameborder="0"><a href="https://www.nicovideo.jp/watch/sm31667442">ダダダダ天使 / ナナヲアカリ</a></iframe>

7/31、8 周年だそうです。 ...もうそんなに経ったのか

# ことの発端

IPv6 アドレスは、手動で受け取るより、ra などで受け取った方が楽だと思う。  
多分固定アドレスだけど、固定じゃない場合を想定して、ね。

NTT 回線をご利用の場合は、電話なしだと ra での受信となる。有名なやつ  
我が家は~~忌々しい、来る電話の 90%が詐欺かアンケートな~~電話を解約してしまったため、アドレスは ra での受け取りとなってます。

openwrt でアドレスを受け取ろうと思ったのですが、思うようにうまくいかなかったので備忘録として書きます。

# 環境

- 実機: [fortigate 50e](https://taiha.hatenablog.jp/entry/2023/03/10/004523)
- openwrt ver: Snapshot(OpenWrt SNAPSHOT r28931-90dee1ab30)

# 前提知識

私の知ってる範囲での知識披露

## IPv6

次世代の Internet Protocol。 これに置き換えようと色々頑張ってる。  
IPv4 の 4 倍の長さを持つアドレス(32bit -> 128bit)  
**アドレスが長く割り当てずらい欠点を克服するために、RA と DHCPv6 という仕組みが存在してる。**

## prefix と suffix

IPv6 アドレスは、IPv4 アドレスと同じく、ルーティングに使われる。  
このルーティングというのは、**アドレスの左から右にかけて、細かくなっていく**

似たようなものとして郵便番号がある。 郵便番号も、**左から右にかけて情報が細かくなる**

IP アドレスの最後に`/`で区切り、v4 なら 0-32、v6 なら 0-128 の間の数字をつける表記がある。  
これは、**先頭からの bit 数を示してる** この bit 数で、**アドレスの前半、後半を分けて考えることができる。**

> [!TIP]
> v4 はサブネットマスクという表記法もあるが、本質的に一緒なので省略。

例えば、  
1 つ目、`192.168.1.0/16`という表記の v4 アドレスがあるとすれば、

- `192.168`
- `1.0`

と分けることができる。  
2 つ目、`192.168.2.0/16`という表記の v4 アドレスがあるとすれば、

- `192.168`
- `2.0`

と分けることができる。  
3 つ目、`10.0.2.0/16`という表記の v4 アドレスがあるとすれば、

- `10.0`
- `2.0`

と分けることができる。

このうち、**左側**が一致していれば、**同じグループのネットワークに所属している**と見なすことができる。  
つまり、1 つ目と 2 つ目は同じネットワークに所属してる。
一方、**右側**が一致していても、**同じグループとはみなせない**  
つまり、1 つ目と 3 つ目はもちろん、**2 つ目と 3 つ目も同じグループではない**

今まで`/16`でやってきたけど、次に見慣れた`/24`に変える。 1 つ目と 2 つ目を比較しよう

| 表記          | 前半        | 後半 |
| ------------- | ----------- | ---- |
| `192.168.1.0` | `192.168.1` | `0`  |
| `192.168.2.0` | `192.168.2` | `0`  |

bit 数を増やすと、1 つ目と 2 つ目が別のグループになってしまった。  
言い方を変えると、もっと細かくみたということになる。大雑把、**外から見れば 1 つめも 2 つめも同じグループだったが、**  
詳細に、**内から見れば 1 つめと 2 つめは違うグループとなる**

実際のルーティングも、**外になるほど大雑把にルーティングし、内になるほど細かくルーティングする**

## RA

RA はルーター広告という機能で...
(詳細は追記します)

# openwrt で ra で prefix を受け取る時

**RA でも DHCPv6 インターフェイスで行う必要がある。** が結論です。
しかも**詳細設定で IPv6 プレフィックスの委任を有効化する必要があります**

この手順を踏まないとアドレスがきませんでした。

## FW の設定も注意

fw で設定する時、**ICMPv6 を通すようにすることを忘れないように**してください！！

また、**インターフェイスにあるゾーンでは完璧に設定ができない**ので、**必要に応じて手動でルールを追加してください!!**

# 以上

もう 19 時過ぎててやばいやばい
