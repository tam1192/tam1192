# HTTP ã§ã‚ãã¼ã† part2

å‰å›è¨˜äº‹ã‚’ä½œã‚Šè¾¼ã¿ã™ãã¦å¾Œæ‚”ã—ã¾ã—ãŸã€‚
ä»Šå›ã‹ã‚‰ãƒ•ãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è»½ã‚ã§æ›¸ããŸã„ã¨æ€ã„ã¾ã™ã€‚

## æœ¬æ—¥ã® 1 æ›² ğŸ¶

[ãƒ¬ãƒ³ã‚ºãƒ•ãƒ¬ã‚¢ - feat.éŸ³æ¥½çš„åŒä½ä½“(V.I.P)](https://www.nicovideo.jp/watch/sm43424657)  
åŒä½ä½“ 5 äººã®åˆå”±æ›²ã€‚ ã‹ã£ã“ã‚ˆã™ãã‚‹ã€‚

## â˜… ã«ã¤ã„ã¦ (â˜…â˜…â˜…)

â˜… ã¯ã“ã®è¨˜äº‹ã®ä¸­ã§ã¨ã‚Šã‚ãˆãšèª­ã‚“ã§æ¬²ã—ã„ã¨ã“ã‚ã« 3ã€è‡ªåˆ†ç”¨ã®ãƒ¡ãƒ¢ãƒ¬ãƒ™ãƒ«ã§ 1 ã‚’ã¤ã‘ã¦ã¾ã™ã€‚  
ãªã®ã§ã€â˜…1 ã®å†…å®¹ãŒç†è§£ã§ããªãã¦ã‚‚å•é¡Œãªã„ã§ã™! æ›¸ã„ã¦ã‚‹ã‚„ã¤ãŒæ‚ªã„ã€‚  
ä¸€æ–¹ â˜…3 ã¯é ‘å¼µã£ã¦æ›¸ãã¾ã—ãŸã®ã§èª­ã‚“ã§æ¬²ã—ã„ãªã€œ

# æœ¬é¡Œ (â˜…â˜…â˜†)

å‰å›ã€HTTP ã®æ§‹æ–‡è§£æï¼ˆãƒ‘ãƒ¼ã‚¹ï¼‰ã‚’è¡Œã„ã¾ã—ãŸã€‚  
ã“ã‚Œã‚’ä½¿ãˆã°ã€å—ä¿¡ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ HTTP ã‚’ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«ç›´ã™ã“ã¨ãŒã§ãã€ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã§ã™ã€‚

ã¨ã‚Šã‚ãˆãšã€ã“ã‚Œã‚’ä½¿ã£ã¦é€šä¿¡ã‚’å®Ÿç¾ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚

## æ“¬ä¼¼é€šä¿¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã£ã¦ã¿ã‚‹ (â˜…â˜…â˜†)

æ“¬ä¼¼é€šä¿¡ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€ã¤ã¾ã‚Šé€šä¿¡ã¯ã—ãªã„ãŒé€šä¿¡ã—ã¦ã‚‹ã‚ˆã†ã«è¦‹ã›ã‹ã‘ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚  
å…·ä½“çš„ã«ã¯ Read ãƒˆãƒ¬ã‚¤ãƒˆã¨ Write ãƒˆãƒ¬ã‚¤ãƒˆã‚’å®Ÿè£…ã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ã™ã€‚

ä¸»ãªç”¨é€”ã¯è¨˜äº‹ã‚„ãƒ†ã‚¹ãƒˆç”¨ã§ã™ã€‚

```rust, ignore
{{#include ./../code/src/vnet/mod.rs}}
```

é•·å¤§ãªã‚³ãƒ¼ãƒ‰ã§ã™ãŒã€ãã®å¤§åŠã¯~~AI è£œå®Œ~~trait ã‚’å®Ÿè£…ã™ã‚Œã°çµ‚ã‚ã‚Šã¾ã™ã€‚
å†…å®¹ã®èª¬æ˜ã¯è‡³ã£ã¦ã‚·ãƒ³ãƒ—ãƒ«ã§ã€æ¨™æº–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«å­˜åœ¨ã™ã‚‹`TcpLisner`ã¨`TcpStream`ã‚’æœ€ä½é™ãƒ¬ãƒ™ãƒ«ã§æ¨¡ã—ãŸã ã‘ã§ã™ã€‚
ãã®ãŸã‚ã€`accept()`ãƒ¡ã‚½ãƒƒãƒ‰ã§é€šä¿¡ã‚’å—ä¿¡ã€`read()`ã‚„`write()`ãŒãã®ã¾ã¾ä½¿ãˆã¾ã™ã€‚

`accept()`ã§å—ä¿¡ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã€ã‚­ãƒ¥ãƒ¼æ–¹å¼ã«å¯¾å¿œã—ãŸ Vec `VecDeque` ã«æ ¼ç´ã—ã¦ãŠã‚Šã€æ ¼ç´æ‰‹æ®µã‚’æä¾›ã™ã‚‹ãŸã‚ã« `add_request()` ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ãŠã‚Šã¾ã™ã€‚
ã“ã‚Œã¯å®Ÿéš›ã®`TcpLisner`ã¨ã¯ç•°ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã™ã€‚
`accept()`ã¯ã€ç¾å®Ÿã®å‹•ä½œã‚’æ¨¡ã™ãŸã‚ã«ã€ã‚­ãƒ¥ãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãŒæ¶ˆãˆã¦ã‚‚ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã¡ç¶šã‘ã¾ã™ã€‚  
ã‚­ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹ã§`accept()`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€æ°¸é ã«å¾…ã¤ã“ã¨ã«ãªã‚Šã¾ã™ã®ã§æ³¨æ„ã€‚

ãƒ†ã‚¹ãƒˆç”¨ã«`get_write_data()`ãƒ¡ã‚½ãƒƒãƒ‰ã‚’æä¾›ã—ã¦ã¾ã™ã€‚ ã“ã‚Œã¯`flush()`å¾Œã§ãªã„ã¨`None`ã‚’è¿”ã—ã¾ã™ï¼

## å®Ÿéš›ã«ä½¿ã£ã¦ã¿ã‚‹

ã‚ã¾ã‚Šã«ã‚‚å†…å®¹ãŒè–„ã‹ã£ãŸã®ã§ã€æµçŸ³ã«å–„å‡¦ã™ã‚‹ã“ã¨ã¨ã—ã¾ã™ã€‚ (ã“ã®è¨˜äº‹ã¯ä¸€å›æ›´æ–°ã—ã¾ã—ãŸã€‚)
å®Ÿéš›ã«å‹•ã‹ã™ã¨ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

(request ã‚’æ¥ã‚‹ã¨ã cl -> sv)

```rust,ignore
// listenerã‚’é–‹ã
let mut listener = TcpListener::bind("127.0.0.1:80").unwrap();
let data = b"GET / HTTP/1.1\r\nhost: localhost\r\naccept: */*\r\n\r\n";
listener.add_request(data);

// (æœ¬æ¥ã¯ãƒ«ãƒ¼ãƒ—åˆ†) é€šä¿¡ãŒããŸã‚‰streamãŒå‡ºã¦ãã‚‹ã€‚
let (mut stream, _) = listener.accept().unwrap();
// ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ã¿ã‚‹
let mut buf = [0u8;1024];
let size = stream.read(&mut buf).unwrap();
let buf = &buf[0..size];
println!("{}", String::from_utf8_lossy(&buf));

// assert_eqã§ç¢ºã‹ã‚ã‚‹
assert_eq!(buf, data);
```

(response é€ã‚‹ã¨ã sv -> cl)

```rust,ignore
// listenerã‚’é–‹ã
let mut listener = TcpListener::bind("127.0.0.1:80").unwrap();
listener.add_request("\r\n".as_bytes());

// (æœ¬æ¥ã¯ãƒ«ãƒ¼ãƒ—åˆ†) é€šä¿¡ãŒããŸã‚‰streamãŒå‡ºã¦ãã‚‹ã€‚
let (mut stream, _) = listener.accept().unwrap();
// ãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ã¦ã¿ã‚‹
let data = "HTTP/1.1 200 Ok\r\nContent-Type: text/plain\r\n\r\nhello!\r\n";
_ = stream.write(data.as_bytes());
_ = stream.flush(); // å¿˜ã‚Œãšã«!

assert_eq!(stream.get_write_data().unwrap(), data.as_bytes());
```

<details><summary>å®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰</summary>

```rust,editable

{{#include ./../code/src/vnet/mod.rs}}

fn main() {
    // é€ã‚‹ã¨ã
    {
        // listenerã‚’é–‹ã
        let mut listener = TcpListener::bind("127.0.0.1:80").unwrap();
        let data = b"GET / HTTP/1.1\r\nhost: localhost\r\naccept: */*\r\n\r\n";
        listener.add_request(data);

        // (æœ¬æ¥ã¯ãƒ«ãƒ¼ãƒ—åˆ†) é€šä¿¡ãŒããŸã‚‰streamãŒå‡ºã¦ãã‚‹ã€‚
        let (mut stream, _) = listener.accept().unwrap();
        // ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ã¿ã‚‹
        let mut buf = [0u8;1024];
        let size = stream.read(&mut buf).unwrap();
        let buf = &buf[0..size];
        println!("{}", String::from_utf8_lossy(&buf));

        // assert_eqã§ç¢ºã‹ã‚ã‚‹
        assert_eq!(buf, data);
    }
    {
        // listenerã‚’é–‹ã
        let mut listener = TcpListener::bind("127.0.0.1:80").unwrap();
        listener.add_request("\r\n".as_bytes());

        // (æœ¬æ¥ã¯ãƒ«ãƒ¼ãƒ—åˆ†) é€šä¿¡ãŒããŸã‚‰streamãŒå‡ºã¦ãã‚‹ã€‚
        let (mut stream, _) = listener.accept().unwrap();
        // ãƒ‡ãƒ¼ã‚¿ã‚’é€ã£ã¦ã¿ã‚‹
        let data = "HTTP/1.1 200 Ok\r\nContent-Type: text/plain\r\n\r\nhello!\r\n";
        _ = stream.write(data.as_bytes());
        _ = stream.flush(); // å¿˜ã‚Œãšã«!

        assert_eq!(stream.get_write_data().unwrap(), data.as_bytes());
    }
}

```

</details>

## buf ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦

å°‘ã—å‰ã« buf ã®å–ã‚Šæ‰±ã„ã§æ³¨æ„ã™ã‚‹ã¹ãå†…å®¹ã‚’è¼‰ã›ãŸè¨˜äº‹ã‚’æ›¸ãã¾ã—ãŸãŒã€ãŠã•ã‚‰ã„ã€‚

- ã‚¹ã‚¿ãƒƒã‚¯ä¸Šã«ãŠãã®
- 0 åŸ‹ã‚ã—ã¦ãŠã

```rust
let buf = [0u8; 10];
```

ãã®è¨˜äº‹ã¯[ã“ã¡ã‚‰](../../../ã²ã¨ãã¡ãƒ¡ãƒ¢/rustã§bufferã‚’ä½œã‚‹æ™‚ã¯)

ãªãŠã€ã“ã®æ“¬ä¼¼ buffer ã‚’ä½¿ã£ã¦ã‚‚å½“ç„¶ã€ãã®å•é¡Œã¯èµ·ãã‚‹ã®ã§æ³¨æ„ã§ã™ï¼

```rust,ignore
// (æœ¬æ¥ã¯ãƒ«ãƒ¼ãƒ—åˆ†) é€šä¿¡ãŒããŸã‚‰streamãŒå‡ºã¦ãã‚‹ã€‚
let (mut stream, _) = listener.accept().unwrap();
// ãƒ‡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ã¦ã¿ã‚‹
let mut buf = Vec::new(); // å‹•ä½œã—ãªã„ï¼
let size = stream.read(&mut buf).unwrap();
let buf = &buf[0..size];
println!("{}", String::from_utf8_lossy(&buf));
```

> [!TIP]
> ä¸Šã®ã€Œå®Ÿéš›ã«å‹•ä½œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã€ã¯ç·¨é›†ã§ãã‚‹ã®ã§ã€  
> è©¦ã—ã¦ã¿ã¦ãã ã•ã„ï¼
> ![å¤‰æ›´ä¾‹](./figure01.png)

## ã¾ã¨ã‚

æ“¬ä¼¼çš„ã«å†ç¾å¯èƒ½ãª TCPListener ã¨ TCPSocket ã‚’ä½œã£ãŸã€‚ ãƒ†ã‚¹ãƒˆãªã©ã§å¿œç”¨ãŒåŠ¹ããã†ã ã€‚  
æœ€è¿‘å¯ä¸ã‚§ã‚¤ãƒ³ãŒä¸è¶³ã—ã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã€‚
